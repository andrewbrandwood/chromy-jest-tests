{"version":3,"sources":["../src/document.js"],"names":["chainProxy","require","uuidV4","TimeoutError","GotoTimeoutError","WaitTimeoutError","EvaluateTimeoutError","EvaluateError","wrapFunctionForEvaluation","wrapFunctionForCallFunction","escapeHtml","escapeSingleQuote","createChromeLauncher","completeUrl","Document","chromy","client","nodeId","_originalNodeId","options","selector","callback","getBoundingClientRect","rect","Promise","resolve","getPageOffset","originalPageOffset","doc","scrollTo","top","newRect","locationParams","x","left","y","DOM","getNodeForLocation","iframeNodeId","_activateOnDocumentUpdatedListener","apply","expr","inputOptions","defaults","waitLoadEvent","Object","assign","promise","_getNodeId","nid","evalExpr","_evaluateOnNode","evaluate","value","sel","src","_evaluateWithReplaces","dx","_1","dy","_2","window","pageXOffset","pageYOffset","replaces","e","_waitFinish","evaluateTimeout","contextNodeId","_getObjectIdFromNodeId","objectId","params","functionDeclaration","Runtime","callFunctionOn","expression","result","subtype","awaitPromise","promiseObjectId","returnByValue","JSON","stringify","type","description","resultObject","parse","undefined","console","log","fn","toString","enable","document","body","querySelector","dom","offsetWidth","offsetHeight","cond","sleep","_waitFunction","_waitSelector","func","waitTimeout","r","waitFunctionPollingInterval","check","startTime","Date","now","reject","setTimeout","timeout","start","finished","error","f","msec","width","height","Math","floor","doms","querySelectorAll","Array","prototype","map","call","rects","_onDocumentUpdatedListener","documentUpdated","resolveNode","rObj","object","getDocument","root","module","exports"],"mappings":"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","file":"document.js","sourcesContent":["const chainProxy = require('async-chain-proxy')\nconst uuidV4 = require('uuid/v4')\n\nconst {\n  TimeoutError,\n  GotoTimeoutError,\n  WaitTimeoutError,\n  EvaluateTimeoutError,\n  EvaluateError\n} = require('./error')\nconst {\n  wrapFunctionForEvaluation,\n  wrapFunctionForCallFunction\n} = require('./functionToSource')\nconst {\n  escapeHtml,\n  escapeSingleQuote,\n  createChromeLauncher,\n  completeUrl\n} = require('./util')\n\nclass Document {\n  constructor (chromy, client, nodeId = null) {\n    if (chromy) {\n      this.chromy = chromy\n    } else {\n      this.chromy = this\n    }\n    this.client = client\n    this.nodeId = nodeId\n    this._originalNodeId = nodeId\n  }\n\n  chain (options = {}) {\n    return chainProxy(this, options)\n  }\n\n  async iframe (selector, callback) {\n    const rect = await this.getBoundingClientRect(selector)\n    if (!rect) {\n      return Promise.resolve()\n    }\n    // to get the the node for location, a position of the node must be in a viewport.\n    const originalPageOffset = await this.getPageOffset()\n    let doc = null\n    try {\n      await this.scrollTo(0, rect.top)\n      const newRect = await this.getBoundingClientRect(selector)\n      const locationParams = {x: rect.left + 10, y: rect.top + 10}\n      const {nodeId: iframeNodeId} = await this.client.DOM.getNodeForLocation(locationParams)\n      if (!iframeNodeId) {\n        return Promise.resolve()\n      }\n      doc = new Document(this.chromy, this.client, iframeNodeId)\n      doc._activateOnDocumentUpdatedListener()\n    } finally {\n      // restore scroll potion.\n      await this.scrollTo(originalPageOffset.x, originalPageOffset.y)\n    }\n    return Promise.resolve(callback.apply(this, [doc]))\n  }\n\n  async click (expr, inputOptions = {}) {\n    const defaults = {waitLoadEvent: false}\n    const options = Object.assign({}, defaults, inputOptions)\n    let promise = null\n    if (options.waitLoadEvent) {\n      promise = this.waitLoadEvent()\n    }\n    let nid = await this._getNodeId()\n    let evalExpr = 'document.querySelectorAll(\\'' + escapeSingleQuote(expr) + '\\').forEach(n => n.click())'\n    if (this._originalNodeId) {\n      await this._evaluateOnNode(nid, evalExpr)\n    } else {\n      await this.evaluate(evalExpr)\n    }\n    if (promise !== null) {\n      await promise\n    }\n  }\n\n  async insert (expr, value) {\n    expr = escapeSingleQuote(expr)\n    await this.evaluate('document.querySelector(\\'' + expr + '\\').focus()')\n    await this.evaluate('document.querySelector(\\'' + expr + '\\').value = \"' + escapeHtml(value) + '\"')\n  }\n\n  async check (selector) {\n    await this.evaluate('document.querySelectorAll(\\'' + escapeSingleQuote(selector) + '\\').forEach(n => n.checked = true)')\n  }\n\n  async uncheck (selector) {\n    await this.evaluate('document.querySelectorAll(\\'' + escapeSingleQuote(selector) + '\\').forEach(n => n.checked = false)')\n  }\n\n  async select (selector, value) {\n    let sel = escapeSingleQuote(selector)\n    const src = `\n      document.querySelectorAll('${sel} > option').forEach(n => {\n        if (n.value === \"${value}\") {\n          n.selected = true\n        }\n      })\n      `\n    await this.evaluate(src)\n  }\n\n  async scroll (x, y) {\n    return this._evaluateWithReplaces(function () {\n      const dx = _1  // eslint-disable-line no-undef\n      const dy = _2  // eslint-disable-line no-undef\n      window.scrollTo(window.pageXOffset + dx, window.pageYOffset + dy)\n    }, {}, {'_1': x, '_2': y})\n  }\n\n  async scrollTo (x, y) {\n    return this._evaluateWithReplaces(function () {\n      window.scrollTo(_1, _2) // eslint-disable-line no-undef\n    }, {}, {'_1': x, '_2': y})\n  }\n\n  async getPageOffset () {\n    return this.evaluate(_ => {\n      return {\n        x: window.pageXOffset,\n        y: window.pageYOffset\n      }\n    })\n  }\n\n  async evaluate (expr, options = {}) {\n    return await this._evaluateWithReplaces(expr, options)\n  }\n\n  async _evaluateWithReplaces (expr, options = {}, replaces = {}) {\n    let e = null\n    if (this._originalNodeId) {\n      e = wrapFunctionForCallFunction(expr, replaces)\n    } else {\n      e = wrapFunctionForEvaluation(expr, replaces)\n    }\n    try {\n      let result = await this._waitFinish(this.chromy.options.evaluateTimeout, async () => {\n        if (!this.client) {\n          return null\n        }\n        if (this._originalNodeId) {\n          // must call callFunctionOn() for evaluating expression with iframe context.\n          const contextNodeId = await this._getNodeId()\n          const objectId = await this._getObjectIdFromNodeId(contextNodeId)\n          const params = Object.assign({}, options, {objectId: objectId, functionDeclaration: e})\n          return await this.client.Runtime.callFunctionOn(params)\n        } else {\n          return await this.client.Runtime.evaluate({expression: e})\n        }\n      })\n      if (!result || !result.result) {\n        return null\n      }\n      // resolve a promise\n      if (result.result.subtype === 'promise') {\n        result = await this.client.Runtime.awaitPromise({promiseObjectId: result.result.objectId, returnByValue: true})\n        // adjust to after process\n        result.result.value = JSON.stringify({\n          type: (typeof result.result.value),\n          result: JSON.stringify(result.result.value)\n        })\n      }\n      if (result.result.subtype === 'error') {\n        throw new EvaluateError('An error has been occurred in evaluated script on a browser.' + result.result.description, result.result)\n      }\n      const resultObject = JSON.parse(result.result.value)\n      const type = resultObject.type\n      if (type === 'undefined') {\n        return undefined\n      } else {\n        try {\n          return JSON.parse(resultObject.result)\n        } catch (e) {\n          console.log('ERROR', resultObject)\n          throw e\n        }\n      }\n    } catch (e) {\n      if (e instanceof TimeoutError) {\n        throw new EvaluateTimeoutError('evaluate() timeout')\n      } else {\n        throw e\n      }\n    }\n  }\n\n  // evaluate a function on the specified node context.\n  async _evaluateOnNode (nodeId, fn) {\n    const objectId = await this._getObjectIdFromNodeId(nodeId)\n    const src = fn.toString()\n    const functionDeclaration = `function () {\n      return (${src})()\n    }`\n    const params = {\n      objectId,\n      functionDeclaration\n    }\n    await this.client.Runtime.enable()\n    await this.client.Runtime.callFunctionOn(params)\n  }\n\n  async exists (selector) {\n    return this._evaluateWithReplaces(\n      _ => { return document.body.querySelector('?') !== null },\n      {}, {'?': escapeSingleQuote(selector)}\n    )\n  }\n\n  async visible (selector) {\n    return this._evaluateWithReplaces(\n      _ => {\n        let dom = document.body.querySelector('?')\n        return dom !== null && dom.offsetWidth > 0 && dom.offsetHeight > 0\n      },\n      {}, {'?': escapeSingleQuote(selector)}\n    )\n  }\n\n  async wait (cond) {\n    if ((typeof cond) === 'number') {\n      await this.sleep(cond)\n    } else if ((typeof cond) === 'function') {\n      await this._waitFunction(cond)\n    } else {\n      await this._waitSelector(cond)\n    }\n  }\n\n  // wait for func to return true.\n  async _waitFunction (func) {\n    await this._waitFinish(this.chromy.options.waitTimeout, async () => {\n      while (true) {\n        const r = await this.evaluate(func)\n        if (r) {\n          break\n        }\n        await this.sleep(this.chromy.options.waitFunctionPollingInterval)\n      }\n    })\n  }\n\n  async _waitSelector (selector) {\n    let check = null\n    let startTime = Date.now()\n    await new Promise((resolve, reject) => {\n      check = () => {\n        setTimeout(async () => {\n          try {\n            const now = Date.now()\n            if (now - startTime > this.chromy.options.waitTimeout) {\n              reject(new WaitTimeoutError('wait() timeout'))\n              return\n            }\n            const result = await this._evaluateWithReplaces(() => {\n              return document.querySelector('?')\n            }, {}, {'?': escapeSingleQuote(selector)})\n            if (result) {\n              resolve(result)\n            } else {\n              check()\n            }\n          } catch (e) {\n            reject(e)\n          }\n        }, this.chromy.options.waitFunctionPollingInterval)\n      }\n      check()\n    })\n  }\n\n  async _waitFinish (timeout, callback) {\n    const start = Date.now()\n    let finished = false\n    let error = null\n    let result = null\n    const f = async () => {\n      try {\n        result = await callback.apply()\n        finished = true\n        return result\n      } catch (e) {\n        error = e\n        finished = true\n      }\n    }\n    f.apply()\n    while (!finished) {\n      const now = Date.now()\n      if ((now - start) > timeout) {\n        throw new TimeoutError('timeout')\n      }\n      await this.sleep(this.chromy.options.waitFunctionPollingInterval)\n    }\n    if (error !== null) {\n      throw error\n    }\n    return result\n  }\n\n  async sleep (msec) {\n    await new Promise((resolve, reject) => {\n      setTimeout(() => {\n        resolve()\n      }, msec)\n    })\n  }\n\n  async getBoundingClientRect (selector) {\n    const rect = await this._evaluateWithReplaces(function () {\n      let dom = document.querySelector('?')\n      if (!dom) {\n        return null\n      }\n      let r = dom.getBoundingClientRect()\n      return {top: r.top, left: r.left, width: r.width, height: r.height}\n    }, {}, {'?': escapeSingleQuote(selector)})\n    if (!rect) {\n      return null\n    }\n    return {\n      top: Math.floor(rect.top),\n      left: Math.floor(rect.left),\n      width: Math.floor(rect.width),\n      height: Math.floor(rect.height)\n    }\n  }\n\n  async getBoundingClientRectAll (selector) {\n    const rects = await this._evaluateWithReplaces(function () {\n      let doms = document.querySelectorAll('?')\n      return Array.prototype.map.call(doms, dom => {\n        let r = dom.getBoundingClientRect()\n        return {top: r.top, left: r.left, width: r.width, height: r.height}\n      })\n    }, {}, {'?': escapeSingleQuote(selector)})\n    return rects.map(rect => {\n      return {\n        top: Math.floor(rect.top),\n        left: Math.floor(rect.left),\n        width: Math.floor(rect.width),\n        height: Math.floor(rect.height)\n      }\n    })\n  }\n\n  _activateOnDocumentUpdatedListener () {\n    this._onDocumentUpdatedListener = () => {\n      this.nodeId = null\n    }\n    this.client.DOM.documentUpdated(this._onDocumentUpdatedListener)\n  }\n\n  async _getObjectIdFromNodeId (nodeId) {\n    const {object: rObj} = await this.client.DOM.resolveNode({nodeId})\n    if (!rObj) {\n      return null\n    }\n    return rObj.objectId\n  }\n\n  async _getNodeId () {\n    if (!this.nodeId) {\n      let {root} = await this.client.DOM.getDocument()\n      this.nodeId = root.nodeId\n    }\n    return this.nodeId\n  }\n\n}\n\nmodule.exports = Document\n"]}